name: post-merge

on:
  push:
    branches:
      - spt-1621-test-image

permissions:
  contents: read
  id-token: write
  packages: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      acceptance-tests-changed: ${{ steps.filter.outputs.changes.acceptance-tests }}
    steps:
      - uses: actions/checkout@v5

      - uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: filter
        with:
          filters: |
            acceptance-tests:
              - .github/workflows/build-test-image.yaml
              - tests/acceptance/**
              - cucumber.json
              - tsconfig.json
              - package.json
              - package-lock.json  

  build:
    uses: ./.github/workflows/build.yml
    needs: detect-changes
    with:
      artifact-name: built-code
      aws-region: eu-west-2
    permissions:
      contents: read
      packages: read

  run-tests:
    uses: ./.github/workflows/test.yml
    needs: detect-changes
    permissions:
      contents: read
      packages: read
    secrets:
      sonar-token: ${{ secrets.SONAR_TOKEN }}

  preview-main:
    uses: ./.github/workflows/deploy-to-aws.yml
    needs:
      - build
      - run-tests
    permissions:
      id-token: write
      contents: read
    secrets:
      aws-role-arn: ${{ secrets.GHA_AWS_ROLE_ARN }}
      aws-s3-bucket: ${{ secrets.GHA_SAM_DEPLOYMENT_BUCKET }}

  # TODO: Disabled at the moment due to WAF rules needing to be added for mock.credential-store.dev.account.gov.uk
  #
  # acceptance-test:
  #   uses: ./.github/workflows/acceptance-tests.yml
  #   needs:
  #     - preview-main
  #   permissions:
  #     id-token: write
  #     contents: read
  #   with:
  #     stack-name: ${{ needs.preview-main.outputs.stack-name }}
  #   secrets:
  #     aws-role-arn: ${{ secrets.GHA_AWS_ROLE_ARN }}

  publish-test-image:
    uses: ./.github/workflows/build-test-image.yml
    needs:
      # - acceptance-test
      - preview-main
      - detect-changes
    if: needs.detect-changes.outputs.acceptance-tests-changed
    permissions:
      contents: read
      id-token: write
      packages: read

  publish:
    uses: ./.github/workflows/publish.yml
    needs:
      - publish-test-image
      - preview-main
    if: |
      always() &&
      (needs.publish-test-image.result == 'success' || needs.publish-test-image.result == 'skipped') &&
      (needs.preview-main.result == 'success' || needs.preview-main.result == 'skipped')
    permissions:
      contents: read
      id-token: write
    with:
      artifact-name: built-code
      aws-region: eu-west-2
    secrets:
      aws-role-arn: ${{ secrets.GHA_AWS_ROLE_ARN }}
      sam-s3-bucket: ${{ secrets.GHA_SAM_DEPLOYMENT_BUCKET }}
      signing-profile-name: ${{ secrets.SIGNING_PROFILE_NAME }}
