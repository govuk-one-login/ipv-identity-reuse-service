---
openapi: 3.0.3
info:
  title: "SIS External – Stored Identity"
  description: "External API for retrieving a user’s stored identity record"
  version: "1.0.0"
paths:
  /user-identity:
    post:
      summary: "Retrieve the user’s stored identity record"
      description: >
        Returns the signed Stored Identity JWT and associated metadata
        indicating whether the record is still valid, whether it has expired,
        and the stored vector of trust (VOT).
      security:
        - bearerAuth: []
      tags:
        - Stored Identity
      requestBody:
        description: User Input containing Vtr and govuk signin ID.
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/userIdentityInput"
      responses:
        "200":
          description: "Stored identity record returned"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/storedIdentityResponse"
        "401":
          description: "Unauthorized – e.g. missing or invalid access token"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/oauthError"
        "403":
          description: "Forbidden – e.g. expired access token"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/oauthError"
        "404":
          description: "Not Found – No Stored Identity exists for this user or Stored Identity has been invalidated"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/oauthError"
        "500":
          description: "Internal server error"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/oauthError"
      x-amazon-apigateway-request-validator: ALL
      x-amazon-apigateway-integration:
        httpMethod: POST
        uri:
          Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${UserIdentityFunction.Arn}:live/invocations
        credentials:
          Fn::GetAtt: UserIdentityRestApiRole.Arn
        passthroughBehavior: NEVER
        contentHandling: CONVERT_TO_TEXT
        type: AWS_PROXY
components:
  schemas:
    userIdentityInput:
      description: |-
        The input parameters passed into the request .
      type: object
      properties:
        vtr:
          type: array
          items:
            type: string
            enum:
              - P1
              - P2
              - P3
              - P4
        govukSigninJourneyId:
          type: string
          description: "Unique journey identifier"
      required:
        - vtr
        - govukSigninJourneyId
    storedIdentityResponse:
      type: object
      properties:
        content:
          ref: "#/components/schemas/userIdentityDataType"
          description: "The expanded body of the signed Stored Identity JWT"
        isValid:
          type: boolean
          description: "Indicates whether SIS considers the stored record still usable"
        kidValid:
          type: boolean
          description: "Indicates whether kid values are verified"
        signatureValid:
          type: boolean
          description: "Indicates whether the kid was valid and signature was verified successfully "
        expired:
          type: boolean
          description: "Indicates whether SIS considers the stored record past its expiry window"
        vot:
          type: string
          description: "The vector of trust that was stored with the record"
      required:
        - content
        - isValid
        - expired
        - vot
        - kidValid
        - signatureValid
    userIdentityDataType:
      type: object
      properties:
        sub:
          type: string
        vot:
          type: string
        vtm:
          type: string
        credentials:
          type: array
          items:
            type: string
          description: A list of JWT signatures that reference the credential JWTs that achieve the maximum vot
        "https://vocab.account.gov.uk/v1/credentialJWT":
          type: array
          items:
            type: string
        "https://vocab.account.gov.uk/v1/coreIdentity":
          type: "object"
          properties:
            name:
              type: array
              items:
                type: object
                # API Gateway doesn't support these external references
                # but they may be turned into $ref's by tooling that does
                description: https://vocab.account.gov.uk/v1/json-schemas/Name.json
            birthDate:
              type: array
              items:
                type: object
                # API Gateway doesn't support these external references
                # but they may be turned into $ref's by tooling that does
                description: https://vocab.account.gov.uk/v1/json-schemas/BirthDate.json
          required:
            - name
            - birthDate
          additionalProperties: false
        "https://vocab.account.gov.uk/v1/address":
          type: "array"
          items:
            type: object
            # API Gateway doesn't support these external references
            # but they may be turned into $ref's by tooling that does
            description: https://vocab.account.gov.uk/v1/json-schemas/PostalAddress.json
        "https://vocab.account.gov.uk/v1/passport":
          type: "array"
          items:
            type: object
            # API Gateway doesn't support these external references
            # but they may be turned into $ref's by tooling that does
            description: https://vocab.account.gov.uk/v1/json-schemas/PassportDetails.json
        "https://vocab.account.gov.uk/v1/drivingPermit":
          type: "array"
          items:
            type: object
            # API Gateway doesn't support these external references
            # but they may be turned into $ref's by tooling that does
            description: https://vocab.account.gov.uk/v1/json-schemas/DrivingPermit.json
        "https://vocab.account.gov.uk/v1/socialSecurityRecord":
          type: "array"
          items:
            type: object
            # API Gateway doesn't support these external references
            # but they may be turned into $ref's by tooling that does
            description: https://vocab.account.gov.uk/v1/json-schemas/SocialSecurityRecord.json
      required:
        - sub
        - vot
        - vtm
        - credentials
      additionalProperties: false
    oauthError:
      type: object
      properties:
        error:
          type: string
        error_description:
          type: string
      required:
        - error
      additionalProperties: false

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer

x-amazon-apigateway-request-validators:
  ALL:
    validateRequestBody: true
    validateRequestParameters: true
    validateRequestHeaders: true
